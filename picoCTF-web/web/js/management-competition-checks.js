// Generated by CoffeeScript 1.10.0
var Accordion, Badge, Button, Col, CompetitionCheck, Glyphicon, ListGroup, ListGroupItem, Panel, TestGroup, TestGroupItem, update;

ListGroupItem = ReactBootstrap.ListGroupItem;

ListGroup = ReactBootstrap.ListGroup;

Accordion = ReactBootstrap.Accordion;

Panel = ReactBootstrap.Panel;

Button = ReactBootstrap.Button;

Glyphicon = ReactBootstrap.Glyphicon;

Col = ReactBootstrap.Col;

Badge = ReactBootstrap.Badge;

update = React.addons.update;

TestGroupItem = React.createClass({displayName: "TestGroupItem",
  render: function() {
    var elapsedDisplay, glyphName, glyphStyle;
    glyphName = "asterik";
    glyphStyle = "";
    switch (this.props.status) {
      case "waiting":
        glyphName = "refresh";
        glyphStyle = "spin";
        break;
      case "failing":
        glyphName = "remove";
        break;
      case "passing":
        glyphName = "ok";
    }
    elapsedDisplay = "...";
    if (this.props.elapsed) {
      elapsedDisplay = (parseFloat(this.props.elapsed).toFixed(1)) + " secs";
    }
    return React.createElement(ListGroupItem, null, React.createElement("h4", null, React.createElement(Glyphicon, {
      "glyph": glyphName,
      "className": glyphStyle
    }), " ", this.props.name, " ", React.createElement("span", {
      "className": "pull-right"
    }, elapsedDisplay)));
  }
});

TestGroup = React.createClass({displayName: "TestGroup",
  getInitialState: function() {
    var state;
    state = {};
    _.map(this.props.tests, function(test) {
      state[test.name] = test;
      state[test.name].status = "waiting";
      return state[test.name].start = Date.now();
    });
    return state;
  },
  updateTestState: function(testName, status) {
    var newState, totalStatus, updateObject;
    updateObject = {};
    updateObject[testName] = {
      status: {
        $set: status
      },
      elapsed: {
        $set: (Date.now() - this.state[testName].start) / 1000.0
      }
    };
    newState = update(this.state, updateObject);
    totalStatus = "passing";
    if (_.any(newState, function(test) {
      return test.status === "waiting";
    })) {
      totalStatus = "waiting";
    } else if (_.any(newState, function(test) {
      return test.status === "failing";
    })) {
      totalStatus = "failing";
    }
    this.setState(newState);
    return this.props.onStatusChange(totalStatus);
  },
  componentWillMount: function() {
    return _.each(this.state, (function(test, testName) {
      return test.func(this.updateTestState.bind(null, testName));
    }).bind(this));
  },
  render: function() {
    return React.createElement(Panel, null, React.createElement(ListGroup, {
      "fill": true
    }, _.map(_.values(this.state), function(test, i) {
      return React.createElement(TestGroupItem, Object.assign({
        "key": i
      }, test));
    })));
  }
});

CompetitionCheck = React.createClass({displayName: "CompetitionCheck",
  getInitialState: function() {
    return {
      competitionReadiness: "waiting"
    };
  },
  alwaysTrue: function(t, setStatus) {
    return setTimeout(setStatus.bind(null, t), Math.random() * 3000);
  },
  checkEnabledProblems: function(setStatus) {
    return apiCall("GET", "/api/admin/problems").done(function(result) {
      var j, len, problem, ref, status;
      status = "failing";
      ref = result.data.problems;
      for (j = 0, len = ref.length; j < len; j++) {
        problem = ref[j];
        if (problem.disabled === false) {
          status = "passing";
          break;
        }
      }
      return setStatus(status);
    });
  },
  checkProblemsAlive: function(setStatus) {
    return apiCall("GET", "/api/admin/shell_servers").done(function(api) {
      var apiCalls, servers, status;
      status = "passing";
      servers = api.data;
      if (servers.length === 0) {
        status = "failing";
      }
      apiCalls = $.map(servers, function(server) {
        return apiCall("GET", "/api/admin/shell_servers/check_status", {
          sid: server.sid
        });
      });
      return $.when.apply(this, apiCalls).done(function() {
        var j, len, ref, result;
        ref = $.map(arguments, _.first);
        for (j = 0, len = ref.length; j < len; j++) {
          result = ref[j];
          if (result.status === 0) {
            status = "failing";
          }
        }
        return setStatus(status);
      });
    });
  },
  checkDownloadsAccessible: function(setStatus) {
    return apiCall("GET", "/api/admin/problems").done(function(result) {
      var instance, j, k, len, len1, problem, ref, ref1, requests, status;
      status = "passing";
      requests = [];
      ref = result.data.problems;
      for (j = 0, len = ref.length; j < len; j++) {
        problem = ref[j];
        ref1 = problem.instances;
        for (k = 0, len1 = ref1.length; k < len1; k++) {
          instance = ref1[k];
          $("<p>" + instance.description + "</p>").find("a").each(function(i, a) {
            var url;
            url = $(a).attr("href");
            return requests.push($.ajax({
              url: url,
              dataType: 'text',
              type: 'GET'
            }));
          });
        }
      }
      return $.when.apply(this, apiCalls).done(function() {
        var l, len2;
        for (l = 0, len2 = arguments.length; l < len2; l++) {
          result = arguments[l];
          if (result.status === 404) {
            status = "failing";
          }
        }
        return setStatus(status);
      });
    });
  },
  onStatusChange: function(status) {
    return this.setState(update(this.state, {
      competitionReadiness: {
        $set: status
      }
    }));
  },
  render: function() {
    var sanityChecks;
    sanityChecks = [
      {
        name: "Check Enabled Problems",
        func: this.checkEnabledProblems
      }, {
        name: "Problems Alive on Shell Servers",
        func: this.checkProblemsAlive
      }
    ];
    return React.createElement("div", null, React.createElement("h3", null, "Competition Status: ", React.createElement("b", null, this.state.competitionReadiness)), React.createElement(Col, {
      "md": 6.,
      "className": "hard-right"
    }, React.createElement(TestGroup, {
      "tests": sanityChecks,
      "onStatusChange": this.onStatusChange
    })));
  }
});
